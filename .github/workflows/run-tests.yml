name: Run tests

# триггер
on: [ push, workflow_dispatch ]

jobs: # аналог этапов
  run-tests:
    name: Set up services (review apps) and run tests
    runs-on: ubuntu-latest
    steps: # шаги конкретной job
      - name: Checkout repository # копируем файлы репозитория внутрь CI агента
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '21'

      - name: Setup Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.9

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Set up services
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq jq
          cd infra && bash restart-docker.sh && cd ..

      - name: Restore Allure history
        uses: actions/cache@v4
        with:
          path: allure-history
          key: allure-history-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            allure-history-

      - name: Run tests
        run: mvn clean test -P ci -q
        env:
          APIBASEURL: http://localhost:4111
          UIBASEURL: http://localhost:3000
          # Локальный Chrome на раннере — обходим Selenoid (Docker API 1.24 vs 1.44 на GitHub)
          UIREMOTE: local

      - name: Prepare Allure results with history
        run: |
          if [ -d allure-history ]; then
            mkdir -p target/allure-results/history
            cp -r allure-history/. target/allure-results/history/
          fi

      - name: Generate Allure report
        run: mvn allure:report -q

      - name: Save Allure history for next run
        if: success()
        run: |
          if [ -d target/site/allure-maven-plugin/history ]; then
            mkdir -p allure-history
            cp -r target/site/allure-maven-plugin/history/. allure-history/
          fi

      - name: Upload Allure report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/site/allure-maven-plugin

      - name: Stop services
        if: always()
        run: cd infra && docker compose down