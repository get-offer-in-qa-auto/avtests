name: Run tests

# триггер
on: [ push, workflow_dispatch ]

jobs: # аналог этапов
  run-tests:
    name: Set up services (review apps) and run tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps: # шаги конкретной job
      - name: Checkout repository # копируем файлы репозитория внутрь CI агента
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '21'

      - name: Setup Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.9

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Set up services
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq jq
          cd ${{ github.workspace }}/infra && bash restart-docker.sh && cd ..

      - name: Download Swagger Coverage CLI
        run: |
          curl -sL -o swagger-coverage.zip https://github.com/viclovsky/swagger-coverage/releases/download/1.5.0/swagger-coverage-1.5.0.zip
          unzip -o swagger-coverage.zip

      - name: Load gh-pages for report history
        if: always()
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0

      - name: Run tests
        run: mvn clean test -P ci -q
        env:
          APIBASEURL: http://localhost:4111
          UIBASEURL: http://localhost:3000
          # Локальный Chrome — Selenoid не совместим с Docker API на GitHub
          UIREMOTE: local

      - name: Prepare Allure history and build report
        if: always()
        run: |
          mkdir -p target/allure-results/history
          LATEST=$(ls -d gh-pages/test-report/*/ 2>/dev/null | sort -t'/' -k3 -nr | head -1)
          if [ -n "$LATEST" ] && [ -d "${LATEST}allure-report/history" ]; then
            cp -r "${LATEST}allure-report/history/"* target/allure-results/history/ 2>/dev/null || true
          fi
          mvn allure:report -q
          mkdir -p allure-history
          cp -r target/site/allure-maven-plugin/* allure-history/

      - name: Run Swagger coverage
        if: always()
        run: |
          SC_DIR=$(find . -maxdepth 2 -type d -name "swagger-coverage-*" | head -1)
          if [ -n "$SC_DIR" ] && [ -d "swagger-coverage-output" ]; then
            chmod +x "$SC_DIR/bin/swagger-coverage-commandline" 2>/dev/null || true
            "$SC_DIR/bin/swagger-coverage-commandline" -s http://localhost:4111/v3/api-docs -i swagger-coverage-output || true
          fi

      - name: Quality gate - API coverage >= 50%
        if: always()
        run: |
          if [ -f swagger-coverage-results.json ]; then
            chmod +x scripts/check-api-coverage.sh
            ./scripts/check-api-coverage.sh swagger-coverage-results.json 50
          fi

      - name: Prepare test-report structure
        if: always()
        run: |
          RUN_NUM=${{ github.run_number }}
          mkdir -p pages-publish/test-report
          if [ -d gh-pages/test-report ]; then
            for prev in gh-pages/test-report/*/; do
              [ -d "$prev" ] || continue
              run=$(basename "$prev")
              [ "$run" = "$RUN_NUM" ] && continue
              mkdir -p "pages-publish/test-report/$run"
              cp -r "$prev"* "pages-publish/test-report/$run/" 2>/dev/null || true
            done
          fi
          mkdir -p pages-publish/test-report/$RUN_NUM/allure-report
          mkdir -p pages-publish/test-report/$RUN_NUM/swagger-coverage
          cp -r allure-history/* pages-publish/test-report/$RUN_NUM/allure-report/ 2>/dev/null || true
          [ -f swagger-coverage-report.html ] && cp swagger-coverage-report.html pages-publish/test-report/$RUN_NUM/swagger-coverage/
          [ -f swagger-coverage-results.json ] && cp swagger-coverage-results.json pages-publish/test-report/$RUN_NUM/swagger-coverage/
          if [ -f swagger-coverage-results.json ]; then
            FULL=$(jq -r '.coverageOperationMap.counter.full // 0' swagger-coverage-results.json)
            PARTY=$(jq -r '.coverageOperationMap.counter.party // 0' swagger-coverage-results.json)
            ALL=$(jq -r '.coverageOperationMap.counter.all // 1' swagger-coverage-results.json)
            [ "$ALL" -gt 0 ] && COVERAGE=$(( (FULL + PARTY) * 100 / ALL )) || COVERAGE=0
            mkdir -p pages-publish/test-report/$RUN_NUM/allure-report/widgets
            echo "{\"apiCoverage\": $COVERAGE, \"full\": $FULL, \"partial\": $PARTY, \"total\": $ALL}" > pages-publish/test-report/$RUN_NUM/allure-report/widgets/coverage.json
          fi

      - name: Create index.html for test-report
        if: always()
        run: |
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Test Reports</title></head><body><h1>Test Reports</h1><ul>' > pages-publish/index.html
          for dir in pages-publish/test-report/*/; do
            [ -d "$dir" ] || continue
            run=$(basename "$dir")
            [[ "$run" =~ ^[0-9]+$ ]] || continue
            echo "<li>Run #$run: <a href=\"test-report/$run/allure-report/index.html\">Allure Report</a> | <a href=\"test-report/$run/swagger-coverage/swagger-coverage-report.html\">Swagger Coverage</a></li>" >> pages-publish/index.html
          done
          echo '</ul></body></html>' >> pages-publish/index.html

      - name: Publish report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: pages-publish

      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: pages-publish

      - name: Stop services
        if: always()
        run: cd ${{ github.workspace }}/infra && docker compose down